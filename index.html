<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Christian N. Kerr</title>

<style>
:root{
  --bg:#bfbfbf; --panel:#b7b7b7; --paper:#fff; --paper2:#f7f7f7; --ink:#000;
  --hi:#fff; --deep:#000; --accent:#ff7a00;
  --mono: ui-monospace, Menlo, Monaco, Consolas, monospace;
  --rail:220px; --gap:12px; --btn:64px; --view:min(86vmin,720px);
  --stroke:2px; --pad:10px; --shadow:0 1px 0 rgba(0,0,0,.25);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:var(--mono); color:var(--ink);
  background:
    repeating-linear-gradient(0deg,rgba(0,0,0,.22) 0 1px,transparent 1px 2px),
    repeating-linear-gradient(90deg,rgba(255,255,255,.18) 0 1px,transparent 1px 2px),
    repeating-linear-gradient(45deg,rgba(0,0,0,.12) 0 1px,transparent 1px 3px),
    var(--bg);
  overflow:hidden;
}

.frame{
  height:100svh;
  display:grid;
  grid-template-columns:var(--rail) 1fr;
  gap:18px;
  padding:
    calc(18px + env(safe-area-inset-top))
    calc(18px + env(safe-area-inset-right))
    calc(18px + env(safe-area-inset-bottom))
    calc(18px + env(safe-area-inset-left));
  align-items:start;
}

.win{
  background:var(--panel);
  padding:var(--pad);
  border:var(--stroke) solid;
  border-color:var(--hi) var(--deep) var(--deep) var(--hi);
  box-shadow:var(--shadow);
}
aside.win{position:sticky;top:18px}

.stage{
  height:100%;
  min-height:0;
  overflow:auto;
  overflow-x:hidden;
  scroll-behavior:smooth;
  overscroll-behavior:contain;
  -webkit-overflow-scrolling:touch;
}

/* panels */
.panel{display:none}
.panel.isActive{display:block}

/* home button */
.nameBtn{
  display:block; width:100%;
  text-align:center;
  font-weight:800; font-size:12px; letter-spacing:.08em;
  padding:8px;
  background:var(--paper);
  border:2px solid #000;
  cursor:pointer; user-select:none;
  margin-bottom:var(--gap);
  color:inherit;
  text-decoration:none;
}
.nameBtn.isActive{background:var(--accent)}

/* controls */
.controls{display:grid;justify-items:center;gap:var(--gap)}

/* compass */
.compass{
  width:var(--btn); height:var(--btn);
  background:#FFF3A0;
  border:2px solid #000;
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center;
}
.compass svg{
  width:52px; height:52px;
  display:block;
  shape-rendering:crispEdges;
  image-rendering:pixelated;
}
.zones{
  position:absolute; inset:0;
  display:grid;
  grid-template:repeat(3,1fr)/repeat(3,1fr);
}
.zone{background:none;border:0;cursor:pointer}

/* nav buttons */
.btns{display:grid;grid-template-columns:var(--btn);gap:10px;justify-content:center}
.btn{
  width:var(--btn); height:var(--btn);
  display:grid; place-items:center;
  background:var(--paper2);
  border:2px solid;
  border-color:var(--hi) var(--deep) var(--deep) var(--hi);
  box-shadow:var(--shadow);
  cursor:pointer; user-select:none;
  color:inherit;
  text-decoration:none;
}
.btn:active{transform:translate(1px,1px)}
.glyph{font-size:32px;font-weight:900;line-height:1}
.btn.isActive{
  background:var(--accent);
  border-color:var(--deep) var(--hi) var(--hi) var(--deep);
}

/* clock button */
.clockBtn{
  width:100%;
  background:#cfe8ff;
  border:2px solid #000;
  padding:8px 10px;
  text-align:center;
  box-shadow:var(--shadow);
  cursor:pointer;
  user-select:none;
  font-family:inherit;
  color:#000;
}
.clockBtn:active{transform:translate(1px,1px)}
.clockLine{font-size:12px;font-weight:800;letter-spacing:.06em}

/* home viewport */
.wrap{width:var(--view);max-width:100%;margin:0}
.viewport{
  width:100%;
  aspect-ratio:1/1;
  overflow:scroll;
  border:2px solid #000;
  background:transparent;
  scrollbar-width:none;
  scroll-behavior:smooth;
  -webkit-overflow-scrolling: touch;
}
@media (min-width:1100px){
  #p-home .viewport{aspect-ratio:3 / 2;}
}
.viewport::-webkit-scrollbar{width:0;height:0}
.canvas{width:220%;height:220%;min-width:1100px;min-height:1100px;position:relative}
.canvas img{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover;
}
.overlayRow{margin-top:8px;display:flex;align-items:center;justify-content:flex-end;gap:10px}
.caption{
  max-width:360px;background:#fff;border:2px solid #000;
  padding:6px 8px;font-size:11px;line-height:1.2;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

.pager{display:flex;gap:6px}
.pbtn{
  width:34px;height:28px;display:grid;place-items:center;
  background:var(--paper2);
  border:2px solid;
  border-color:var(--hi) var(--deep) var(--deep) var(--hi);
  box-shadow:var(--shadow);
  cursor:pointer; user-select:none;
  color:#000;
  font-family:inherit;
}
.pbtn:active{transform:translate(1px,1px)}

/* list box */
.list{
  width:var(--view);max-width:100%;
  background:#fff;border:2px solid #000;
  padding:14px 14px 16px;
  font-size:13px;line-height:1.2;
  box-shadow:var(--shadow);
}
.list h2{margin:0 0 10px;font-size:14px;letter-spacing:.08em}
.rule{height:2px;background:#000;margin:10px 0 12px}
.spacer{height:14px}

.items{margin-top:10px; width:max-content; min-width:100%}
.item{
  padding:6px 0;
  border-top:1px solid rgba(0,0,0,.14);
  font-variant-numeric: tabular-nums;
}
.item:first-child{border-top:0}
.pathRow{
  display:flex;
  align-items:baseline;
  gap:0;
  white-space:nowrap;
}
.prompt{opacity:.95}
.promptLine{display:flex;align-items:baseline;gap:0;white-space:nowrap}
.titleCell{white-space:nowrap}
.sep{opacity:.9; margin:0 4px;}
.metaLine{white-space:nowrap}

/* one horizontal scroller per page */
.pageScroll{
  overflow-x:auto;
  overflow-y:hidden;
  scrollbar-width:none;
  -webkit-overflow-scrolling:touch;
}
.pageScroll::-webkit-scrollbar{width:0;height:0}
.pageInner{width:max-content; min-width:100%}

.list a,
.caption a{
  color:#1f4f8a;
  text-decoration:none;
  -webkit-tap-highlight-color: transparent;
}
.list a:visited,
.caption a:visited{ color:#1f4f8a; }
.list a:focus,
.caption a:focus{
  outline:2px solid #000;
  outline-offset:2px;
}

em{font-style:italic}
.q{ quotes: "“" "”" "‘" "’"; }
.q::before{ content: open-quote; }
.q::after{ content: close-quote; }
.quote{margin-top:12px;font-size:12px;color:#444}

/* mobile */
@media (max-width:820px){
  :root{--rail:1fr;--btn:56px;--view:min(92vmin,720px)}
  .frame{ grid-template-columns:1fr !important; grid-template-rows:auto 1fr !important; }
  aside.win{ position:static !important; top:auto !important; }
  .controls{display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap}
  .btns{grid-template-columns:repeat(3,var(--btn));gap:8px;justify-content:center}
  .clockBtn{flex-basis:100%}
  .list, .wrap{width:100%}
}
@media (max-width:420px){
  :root{--btn:48px}
  .glyph{font-size:28px}
  .caption{max-width:70%;font-size:10px}
}

/* thoughts modal */
.modal{
  position:fixed; inset:0;
  display:none;
  padding:
    calc(18px + env(safe-area-inset-top))
    calc(18px + env(safe-area-inset-right))
    calc(18px + env(safe-area-inset-bottom))
    calc(18px + env(safe-area-inset-left));
  background:rgba(0,0,0,.28);
  z-index:999;
  align-items:center;
  justify-content:center;
}
.modal.isOpen{display:flex}
.modal .win{ width:min(920px, 100%); background:#fff; }
.modalHead{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px; margin-bottom:10px;
}
.modalTitleWrap{ display:flex; align-items:baseline; gap:10px; min-width:0; }
.modalTitle{ font-weight:900; letter-spacing:.08em; font-size:12px; white-space:nowrap; }
.modalIdx{ font-weight:900; font-size:12px; opacity:.75; white-space:nowrap; }
.modalNav{display:flex; gap:8px; align-items:center}
.navBtn,.closeBtn{
  border:2px solid #000;
  background:var(--paper2);
  box-shadow:var(--shadow);
  cursor:pointer;
  padding:6px 10px;
  font-family:inherit;
  user-select:none;
  color:#000;
}
.navBtn{width:42px; text-align:center; padding:6px 0}
.navBtn:active,.closeBtn:active{transform:translate(1px,1px)}
.quoteBox{
  border:2px solid #000;
  background:#fff;
  padding:12px 12px 10px;
  font-size:12px;
  line-height:1.25;
}
.qLine{white-space:pre-wrap; word-break:break-word;}
.qMeta{margin-top:8px; opacity:.65; white-space:pre-wrap;}
@media (max-width:520px){
  .modalTitleWrap{flex-direction:column; align-items:flex-start; gap:2px}
}
</style>
</head>

<body>
<div class="frame" id="root">
  <aside class="win" aria-label="Sidebar">
    <a class="nameBtn" id="linkHomeTop" href="#/home" data-route="home" title="Home" aria-label="Home">Christian N. Kerr</a>

    <div class="controls">
      <div class="compass" aria-label="D-pad">
        <svg viewBox="0 0 64 64" aria-hidden="true">
          <rect x="29" y="14" width="6" height="36" fill="#000"/>
          <rect x="14" y="29" width="36" height="6" fill="#000"/>
          <rect x="26" y="6" width="12" height="6" fill="#000"/>
          <rect x="23" y="12" width="18" height="6" fill="#000"/>
          <rect x="26" y="52" width="12" height="6" fill="#000"/>
          <rect x="23" y="46" width="18" height="6" fill="#000"/>
          <rect x="6" y="26" width="6" height="12" fill="#000"/>
          <rect x="12" y="23" width="6" height="18" fill="#000"/>
          <rect x="52" y="26" width="6" height="12" fill="#000"/>
          <rect x="46" y="23" width="6" height="18" fill="#000"/>
          <rect x="28" y="28" width="8" height="8" fill="#FFF3A0" stroke="#000" stroke-width="2"/>
        </svg>

        <div class="zones" id="zones">
          <button class="zone" data-pan="0,0"   aria-label="Northwest"></button>
          <button class="zone" data-pan=".5,0"  aria-label="North"></button>
          <button class="zone" data-pan="1,0"   aria-label="Northeast"></button>
          <button class="zone" data-pan="0,.5"  aria-label="West"></button>
          <button class="zone" data-pan=".5,.5" aria-label="Center"></button>
          <button class="zone" data-pan="1,.5"  aria-label="East"></button>
          <button class="zone" data-pan="0,1"   aria-label="Southwest"></button>
          <button class="zone" data-pan=".5,1"  aria-label="South"></button>
          <button class="zone" data-pan="1,1"   aria-label="Southeast"></button>
        </div>
      </div>

      <div class="btns" aria-label="Navigation">
        <a class="btn" id="linkWriting"  href="#/writing"  data-route="writing"  title="Writing"  aria-label="Writing"><div class="glyph">写</div></a>
        <a class="btn" id="linkResearch" href="#/research" data-route="research" title="Research" aria-label="Research"><div class="glyph">研</div></a>
        <a class="btn" id="linkContact"  href="#/contact"  data-route="contact"  title="Contact"  aria-label="Contact"><div class="glyph">联</div></a>
      </div>

      <button class="clockBtn" id="clockBtn" type="button" aria-label="Current date and time (triple click for feed)">
        <div class="clockLine" id="clockStamp">—</div>
      </button>
    </div>
  </aside>

  <main class="stage" id="stage" aria-label="Stage">
    <section class="panel" id="p-home">
      <div class="win wrap" id="homeWrap">
        <div class="viewport" id="viewport">
          <div class="canvas" id="canvas">
            <img id="hero" src="" alt="">
          </div>
        </div>

        <div class="overlayRow" id="homeOverlay" aria-label="Image controls">
          <div class="caption" id="caption">—</div>
          <div class="pager">
            <button class="pbtn" id="prev" type="button" aria-label="Previous image" title="Previous">◀</button>
            <button class="pbtn" id="next" type="button" aria-label="Next image" title="Next">▶</button>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" id="p-writing">
      <div class="list">
        <div class="pageScroll" id="scroll-writing">
          <div class="pageInner">
            <h2>WRITING</h2>
            <div class="rule"></div>
            <div class="items" id="items-writing" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" id="p-research">
      <div class="list">
        <div class="pageScroll" id="scroll-researchAll">
          <div class="pageInner">
            <h2>RESEARCH</h2>
            <div class="rule"></div>
            <div class="items" id="items-research" aria-live="polite"></div>

            <div class="spacer"></div>

            <h2>FACT-CHECKING</h2>
            <div class="rule"></div>
            <div class="items" id="items-factChecking" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" id="p-contact">
      <div class="list">
        <h2>CONTACT</h2>
        <div class="rule"></div>
        <p>
          Location: Brooklyn, New York, USA<br>
          Email: <a href="mailto:christian.n.kerr@gmail.com">christian.n.kerr@gmail.com</a><br>
          Socials:
          <a href="https://www.youtube.com/@CNKERR..." target="_blank" rel="noopener">YouTube</a>,
          <a href="https://x.com/cnkerr" target="_blank" rel="noopener">X</a>,
          <a href="https://www.instagram.com/cnkerr" target="_blank" rel="noopener">Instagram</a>
        </p>
        <p class="quote">
          "I celebrate myself, and sing myself, / And what I assume you shall assume, / For every atom belonging to me as good belongs to you." —WW
        </p>
      </div>
    </section>
  </main>
</div>

<!-- THOUGHTS modal -->
<div class="modal" id="thoughtsModal" aria-hidden="true">
  <div class="win">
    <div class="modalHead">
      <div class="modalTitleWrap">
        <div class="modalTitle">Time?</div>
        <div class="modalIdx" id="thoughtsIdx">00/00</div>
      </div>

      <div class="modalNav">
        <button class="navBtn" id="tqPrev" type="button" aria-label="Previous quote">◀</button>
        <button class="navBtn" id="tqNext" type="button" aria-label="Next quote">▶</button>
        <button class="closeBtn" id="closeThoughts" type="button" aria-label="Close">CLOSE</button>
      </div>
    </div>

    <div class="quoteBox" aria-live="polite">
      <div class="qLine" id="tqQuote">&gt; (add quote here)</div>
      <div class="qMeta" id="tqMeta">&gt;&gt; (work / author)</div>
    </div>
  </div>
</div>


<script>
/*
  REQUIREMENT:
  data.js must define:
  window.DATA_REMOTE = { slides:[], writing:[], research:[], factChecking:[], timeQuotes:[] }

  IMPORTANT:
  We load data.js first, then boot the app ONLY after it finishes loading.
  This eliminates the “home images don’t load” race condition.
*/
(function loadDataThenBoot(){
  const boot = () => {
    (() => {
      const $ = (id) => document.getElementById(id);

      const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));

      const stage = $("stage");
      const v = $("viewport");
      const c = $("canvas");

      // --- Pull data (or safe empty fallback) ---
      const DATA = (window.DATA_REMOTE && typeof window.DATA_REMOTE === "object")
        ? window.DATA_REMOTE
        : { slides:[], writing:[], research:[], factChecking:[], timeQuotes:[] };

      // normalize so we never crash on missing keys
      (function normalize(d){
        if (!Array.isArray(d.slides)) d.slides = [];
        if (!Array.isArray(d.writing)) d.writing = [];
        if (!Array.isArray(d.research)) d.research = [];
        if (!Array.isArray(d.factChecking)) d.factChecking = [];
        if (!Array.isArray(d.timeQuotes)) d.timeQuotes = [];
      })(DATA);

      // --- Home pan ---
      const pan = (x,y) => v.scrollTo({
        left: (c.scrollWidth - v.clientWidth) * x,
        top:  (c.scrollHeight - v.clientHeight) * y,
        behavior: "smooth"
      });

      // --- Stage scroll ---
      const scrollStage = (dir, fast=false) =>
        stage.scrollBy({ top: dir * (fast ? 380 : 160), behavior: "smooth" });

      // --- Home auto-fit sizing ---
      const homeWrap = $("homeWrap");
      const homeOverlay = $("homeOverlay");

      const fitHome = () => {
        if (!homeWrap || !homeOverlay || !v) return;
        if (!$("p-home").classList.contains("isActive")) return;

        const stageW = stage.clientWidth;
        const stageH = stage.clientHeight;

        const overlayH = homeOverlay.offsetHeight || 0;
        const safety = 28;

        const maxByW = stageW - 6;
        const maxByH = stageH - overlayH - safety;

        const isWide = window.matchMedia("(min-width:1100px)").matches;
        const aspect = isWide ? (3/2) : 1;

        const isMobile = window.matchMedia("(max-width:820px)").matches;
        const chrome = 44;

        if (isMobile) {
          homeWrap.style.width = maxByW + "px";
          const viewportH = Math.max(220, Math.floor(maxByH - chrome));
          const side = Math.min(maxByW, viewportH);
          v.style.width = "100%";
          v.style.height = side + "px";
          return;
        }

        const height = Math.max(260, Math.floor(maxByH));
        let width = Math.floor(height * aspect);
        width = Math.min(width, maxByW);

        homeWrap.style.width = width + "px";
        v.style.width = "100%";
        v.style.height = Math.floor(width / aspect) + "px";
      };

      window.addEventListener("resize", () => requestAnimationFrame(fitHome), { passive:true });

      // --- Compass behavior (home pans, pages scroll) ---
      const getActivePageScroller = () => {
        if ($("p-writing").classList.contains("isActive")) return $("scroll-writing");
        if ($("p-research").classList.contains("isActive")) return $("scroll-researchAll");
        return null;
      };

      $("zones").addEventListener("click", (e) => {
        const b = e.target.closest("[data-pan]");
        if (!b) return;
        const [x,y] = b.dataset.pan.split(",").map(Number);

        const onHome = $("p-home").classList.contains("isActive");
        if (onHome) return void pan(x,y);

        const sc = getActivePageScroller();
        const dx = 260;
        if (sc && x < 0.5) return void sc.scrollBy({ left: -dx, behavior: "smooth" });
        if (sc && x > 0.5) return void sc.scrollBy({ left:  dx, behavior: "smooth" });

        if (x === 0.5 && y === 0.5) return void stage.scrollTo({ top: 0, behavior: "smooth" });
        if (y < 0.5) return void scrollStage(-1, y === 0);
        if (y > 0.5) return void scrollStage( 1, y === 1);
      });

      // --- Slideshow (requires DATA.slides) ---
      const hero = $("hero");
      const cap = $("caption");
      const prevBtn = $("prev");
      const nextBtn = $("next");

      let slideIndex = Number(localStorage.getItem("slideIndex") || 0) || 0;

      const slides = DATA.slides; // {src, caption}[]
      const setHomeEmptyState = (msg) => {
        hero.removeAttribute("src");
        hero.alt = "";
        cap.textContent = msg || "—";
      };

      const showSlide = (n) => {
        if (!slides.length) {
          setHomeEmptyState("No slides yet (add DATA_REMOTE.slides in data.js).");
          prevBtn.disabled = true;
          nextBtn.disabled = true;
          return;
        }
        prevBtn.disabled = false;
        nextBtn.disabled = false;

        slideIndex = (n + slides.length) % slides.length;
        const s = slides[slideIndex] || {};

        const src = String(s.src || "").trim();
        const caption = String(s.caption || "").trim();

        if (!src) {
          setHomeEmptyState("Slide missing src (check DATA_REMOTE.slides).");
          return;
        }

        hero.src = src;
        hero.alt = caption || "";
        cap.textContent = caption || "—";

        localStorage.setItem("slideIndex", String(slideIndex));
        requestAnimationFrame(() => pan(.5,.5));
      };

      prevBtn.addEventListener("click", () => showSlide(slideIndex - 1));
      nextBtn.addEventListener("click", () => showSlide(slideIndex + 1));
      window.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") showSlide(slideIndex - 1);
        if (e.key === "ArrowRight") showSlide(slideIndex + 1);
      });

      // --- Clock ---
      const clockStamp = $("clockStamp");
      const tick = () => {
        const now = new Date();
        const parts = new Intl.DateTimeFormat("en-US", {
          timeZone: "America/New_York",
          year: "numeric", month: "2-digit", day: "2-digit",
          hour: "2-digit", minute: "2-digit", second: "2-digit",
          hour12: false
        }).formatToParts(now);
        const get = (t) => parts.find(p => p.type === t)?.value || "00";
        clockStamp.textContent =
          `${get("year")}.${get("month")}.${get("day")}T${get("hour")}:${get("minute")}:${get("second")}:ET`;
      };
      tick();
      setInterval(tick, 1000);

      // --- List rendering ---
      const parseMonthYear = (s) => {
        const str = String(s || "").trim();
        const m = str.match(/^([A-Za-z]{3,})\s+(\d{4})$/);
        if (!m) return 0;
        const month = m[1].slice(0,3).toLowerCase();
        const year = Number(m[2]);
        const months = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
        if (!(month in months) || !Number.isFinite(year)) return 0;
        return new Date(year, months[month], 1).getTime();
      };

      const authorPublisherHtml = (s) => {
        const str = String(s || "").trim();
        const m = str.match(/^(.*)\s+\(([^)]+)\)\s*$/);
        if (!m) return esc(str);
        const author = esc(m[1].trim());
        const pub = esc(m[2].trim());
        return `${author} (<em>${pub}</em>)`;
      };

      const row1 = ({ titleHtml, metaHtml }) => `
        <div class="item">
          <div class="pathRow">
            <div class="promptLine">
              <span class="prompt">&gt;</span>
              <span class="titleCell">${titleHtml}</span>
            </div>
            ${metaHtml ? `<span class="sep"> / </span><span class="metaLine">${metaHtml}</span>` : ``}
          </div>
        </div>
      `;

      const render = (section) => {
        const out = $(`items-${section}`);
        if (!out) return;

        const items = (DATA[section] || []).slice().sort((a,b) => {
          if (section === "factChecking") return parseMonthYear(b.date) - parseMonthYear(a.date);
          return (b.year ?? 0) - (a.year ?? 0);
        });

        if (!items.length){
          out.innerHTML = row1({ titleHtml:"No items yet.", metaHtml:"" });
          return;
        }

        if (section === "writing"){
          out.innerHTML = items.map(it => {
            const title = esc(it.title || "");
            const href = it.url ? String(it.url) : "";
            const titleHtml = href
              ? `<a href="${esc(href)}" target="_blank" rel="noopener">${title}</a>`
              : title;

            const pub = it.outlet ? `<em>${esc(it.outlet)}</em>` : "";
            const year = it.year ? esc(it.year) : "";
            const metaHtml = [pub, year].filter(Boolean).join(" / ");
            return row1({ titleHtml, metaHtml });
          }).join("");
          return;
        }

        if (section === "research"){
          out.innerHTML = items.map(it => {
            const raw = esc(it.title || "");
            const inner = it.italic ? `<em>${raw}</em>` : raw;
            const href = it.url ? String(it.url) : "";
            const titleHtml = href
              ? `<a href="${esc(href)}" target="_blank" rel="noopener">${inner}</a>`
              : inner;

            const ap = it.outlet ? authorPublisherHtml(it.outlet) : "";
            const year = it.year ? esc(it.year) : "";
            const metaHtml = [ap, year].filter(Boolean).join(" / ");
            return row1({ titleHtml, metaHtml });
          }).join("");
          return;
        }

        // factChecking
        out.innerHTML = items.map(it => {
          const titleQuoted = `<span class="q">${esc(it.title || "")}</span>`;
          const href = it.url ? String(it.url) : "";
          const titleHtml = href
            ? `<a href="${esc(href)}" target="_blank" rel="noopener">${titleQuoted}</a>`
            : titleQuoted;

          const author = esc(it.author || "");
          const pub = it.publication ? `<em>${esc(it.publication)}</em>` : "";
          const ap = author && pub ? `${author} (${pub})` : (author || (pub ? `(${pub})` : ""));
          const date = esc(it.date || "");
          const metaHtml = [ap, date].filter(Boolean).join(" / ");
          return row1({ titleHtml, metaHtml });
        }).join("");
      };

      // --- Hash router (works on GitHub Pages + custom domains) ---
      const panels = {
        home: $("p-home"),
        writing: $("p-writing"),
        research: $("p-research"),
        contact: $("p-contact"),
      };
      const links = {
        home: $("linkHomeTop"),
        writing: $("linkWriting"),
        research: $("linkResearch"),
        contact: $("linkContact"),
      };

      const normalizeRoute = (hash) => {
        const raw = String(hash || "");
        const m = raw.match(/^#\/(home|writing|research|contact)\b/);
        return m ? m[1] : "home";
      };

      const setActive = (key) => {
        Object.entries(panels).forEach(([k,el]) => el.classList.toggle("isActive", k === key));
        Object.entries(links).forEach(([k,el]) => el.classList.toggle("isActive", k === key));
        stage.scrollTo({ top: 0, behavior: "auto" });
        if (key === "home") requestAnimationFrame(() => { fitHome(); pan(.5,.5); });
      };

      document.addEventListener("click", (e) => {
        const a = e.target.closest("a[data-route]");
        if (!a) return;
        e.preventDefault();
        const key = a.dataset.route || "home";
        location.hash = "#/" + key;
      });

      window.addEventListener("hashchange", () => setActive(normalizeRoute(location.hash)));

      // --- Thoughts modal (triple-click clock) ---
      const modal = $("thoughtsModal");
      const clockBtn = $("clockBtn");
      const tqQuote = $("tqQuote");
      const tqMeta  = $("tqMeta");
      const tqPrev  = $("tqPrev");
      const tqNext  = $("tqNext");
      const tqIdx   = $("thoughtsIdx");
      const closeThoughts = $("closeThoughts");

      const pad2 = (n) => String(n).padStart(2, "0");
      const fmtIdx = (i, total) => `${pad2(i)}/${pad2(total)}`;

      let qi = Number(localStorage.getItem("timeQuoteIndex") || 0) || 0;

      const renderQuote = () => {
        const quotes = Array.isArray(DATA.timeQuotes) ? DATA.timeQuotes : [];
        const total = quotes.length;

        if (!total){
          tqQuote.textContent = "> (add quote here)";
          tqMeta.textContent  = ">> (work / author)";
          tqIdx.textContent   = fmtIdx(0, 0);
          return;
        }

        qi = ((qi % total) + total) % total;
        const q = quotes[qi] || {};
        const text = String(q.quote || "").trim();
        const work = String(q.work || "").trim();
        const author = String(q.author || "").trim();

        tqQuote.textContent = `> ${text || "(add quote here)"}`;
        const metaParts = [];
        if (work) metaParts.push(work);
        if (author) metaParts.push(author);
        tqMeta.textContent = `>> ${metaParts.join(" / ") || "(work / author)"}`;
        tqIdx.textContent = fmtIdx(qi + 1, total);

        localStorage.setItem("timeQuoteIndex", String(qi));
      };

      const openModal = () => {
        renderQuote();
        modal.classList.add("isOpen");
        modal.setAttribute("aria-hidden", "false");
      };
      const closeModal = () => {
        modal.classList.remove("isOpen");
        modal.setAttribute("aria-hidden", "true");
      };
      const isOpen = () => modal.classList.contains("isOpen");

      tqPrev.addEventListener("click", () => { qi -= 1; renderQuote(); });
      tqNext.addEventListener("click", () => { qi += 1; renderQuote(); });
      closeThoughts.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

      window.addEventListener("keydown", (e) => {
        if (!isOpen()) return;
        if (e.key === "Escape") closeModal();
        if (e.key === "ArrowLeft") { qi -= 1; renderQuote(); }
        if (e.key === "ArrowRight"){ qi += 1; renderQuote(); }
      });

      let clickCount = 0;
      let clickTimer = null;
      const CLICK_WINDOW_MS = 650;

      clockBtn.addEventListener("click", () => {
        clickCount += 1;
        clearTimeout(clickTimer);
        clickTimer = setTimeout(() => { clickCount = 0; }, CLICK_WINDOW_MS);
        if (clickCount >= 3){
          clickCount = 0;
          openModal();
        }
      });

      // --- INIT ---
      if (!location.hash) location.hash = "#/home";
      setActive(normalizeRoute(location.hash));

      render("writing");
      render("research");
      render("factChecking");

      // slideshow last (so home doesn’t flash blank)
      showSlide(slideIndex);

      requestAnimationFrame(() => { fitHome(); pan(.5,.5); });
    })();
  };

  // Load external data.js FIRST, then boot.
  // IMPORTANT: Do NOT use Date.now() here (causes endless “new URL” and can break caching expectations).
  const DATA_VERSION = ""; // <- optional: set like "20260103-1" when you want cache-bust
  const src = "data.js" + (DATA_VERSION ? ("?v=" + encodeURIComponent(DATA_VERSION)) : "");

  const s = document.createElement("script");
  s.src = src;
  s.async = true;
  s.onload = boot;
  s.onerror = () => {
    console.warn("data.js failed to load — booting with empty DATA_REMOTE.");
    boot();
  };
  document.head.appendChild(s);
})();
</script>
</body>
</html>
