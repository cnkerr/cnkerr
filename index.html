<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Christian N. Kerr</title>

<style>
/* =========================================================
   CSS: TOKENS / BASE
========================================================= */
:root{
  --bg:#bfbfbf; --panel:#b7b7b7; --paper:#fff; --paper2:#f7f7f7; --ink:#000;
  --hi:#fff; --deep:#000; --accent:#ff7a00;
  --mono: ui-monospace, Menlo, Monaco, Consolas, monospace;
  --rail:220px; --gap:12px; --btn:64px;
  --stroke:2px; --pad:10px; --shadow:0 1px 0 rgba(0,0,0,.25);

  /* subtle scrollbar sizing */
  --sb:8px;
  --sbThumb:rgba(0,0,0,.18);
  --sbThumbHover:rgba(0,0,0,.28);
}

*{box-sizing:border-box}
html,body{height:100%}
[hidden]{ display:none !important; }
body{
  margin:0; font-family:var(--mono); color:var(--ink);
  background:
    repeating-linear-gradient(0deg,rgba(0,0,0,.22) 0 1px,transparent 1px 2px),
    repeating-linear-gradient(90deg,rgba(255,255,255,.18) 0 1px,transparent 1px 2px),
    repeating-linear-gradient(45deg,rgba(0,0,0,.12) 0 1px,transparent 1px 3px),
    var(--bg);
  overflow:auto;
}

@media (prefers-reduced-motion: reduce){
  *{ scroll-behavior:auto !important; }
}

/* =========================================================
   CSS: LAYOUT SHELL
========================================================= */
.frame{
  height:100svh;
  display:grid;
  grid-template-columns:var(--rail) 1fr;
  gap:18px;
  padding:
    calc(18px + env(safe-area-inset-top))
    calc(18px + env(safe-area-inset-right))
    calc(18px + env(safe-area-inset-bottom))
    calc(18px + env(safe-area-inset-left));
  align-items:start;
}

/* MOBILE / NARROW: sidebar becomes top bar */
@media (max-width:820px){
  .frame{
    grid-template-columns:1fr;
    grid-template-rows:auto 1fr;
    gap:12px;
  }
  aside.win{ position:relative; top:auto; }
}

.win{
  background:var(--panel);
  padding:var(--pad);
  border:var(--stroke) solid;
  border-color:var(--hi) var(--deep) var(--deep) var(--hi);
  box-shadow:var(--shadow);
}
aside.win{position:sticky;top:18px}

/* Stage never scrolls; each page box scrolls (prevents double scrollbars). */
.stage{
  height:100%;
  min-height:0;
  overflow:hidden;
  -webkit-overflow-scrolling:touch;
}

/* panels */
.panel{display:none; content-visibility:auto; contain-intrinsic-size:800px}
.panel.isActive{display:block; height:100%; content-visibility:visible}

/* =========================================================
   CSS: NAV + CLOCK
========================================================= */
.nameBtn{
  display:block; width:100%;
  text-align:center;
  font-weight:800; font-size:12px; letter-spacing:.08em;
  padding:8px;
  background:var(--paper);
  border:2px solid #000;
  cursor:pointer; user-select:none;
  margin-bottom:var(--gap);
  color:inherit;
  text-decoration:none;
}
.nameBtn.isActive{background:var(--accent)}

.controls{display:grid;justify-items:center;gap:var(--gap)}

.btns{
  display:grid;
  grid-template-columns: var(--btn);
  grid-auto-rows: var(--btn);
  gap:10px;
  justify-content:center;
}

.btn{
  width:var(--btn); height:var(--btn);
  display:grid; place-items:center;
  background:var(--paper2);
  border:2px solid;
  border-color:var(--hi) var(--deep) var(--deep) var(--hi);
  box-shadow:var(--shadow);
  cursor:pointer; user-select:none;
  color:inherit;
  text-decoration:none;
}
.btn:active{transform:translate(1px,1px)}
.glyph{font-size:32px;font-weight:900;line-height:1}
.btn.isActive{
  background:var(--accent);
  border-color:var(--deep) var(--hi) var(--hi) var(--deep);
}

/* Blog: standout by default, but use normal active orange when selected */
#linkNotes:not(.isActive){
  background:#FFF3A0;
}

/* TOP BAR state */
@media (max-width:820px){
  .btns{
    grid-template-columns: repeat(4, var(--btn));
    grid-auto-rows: var(--btn);
    gap:8px;
    justify-content:center;
  }
}

.clockBtn{
  width:100%;
  background:#cfe8ff;
  border:2px solid #000;
  padding:8px 10px;
  text-align:center;
  box-shadow:var(--shadow);
  cursor:pointer;
  user-select:none;
  font-family:inherit;
  color:#000;
}
.clockBtn:active{transform:translate(1px,1px)}
.clockLine{font-size:12px;font-weight:800;letter-spacing:.06em}

@media (max-width:820px){
  aside.win{ padding:8px; }
  .clockBtn{ padding:6px 8px; }
  .clockLine{ font-size:11px; }
}

/* =========================================================
   CSS: SUBTLE SCROLLBARS (reusable)
========================================================= */
.scrollbox{
  overflow:auto;
  overscroll-behavior:contain;
  -webkit-overflow-scrolling:touch;

  scrollbar-width:thin;
  scrollbar-color: var(--sbThumb) transparent;

  scrollbar-gutter: stable both-edges;
}
.scrollbox::-webkit-scrollbar{ width:var(--sb); height:var(--sb); }
.scrollbox::-webkit-scrollbar-track{ background:transparent; }
.scrollbox::-webkit-scrollbar-thumb{
  background:var(--sbThumb);
  border-radius:10px;
  border:3px solid transparent;
  background-clip: padding-box;
}
.scrollbox:hover::-webkit-scrollbar-thumb{ background:var(--sbThumbHover); }
.scrollbox::-webkit-scrollbar-corner{ background:transparent; }

/* =========================================================
   CSS: HOME (ART VIEWER)
========================================================= */
#p-home .wrap{
  width:100%;
  max-width:100%;
  margin:0;
  height:100%;
  display:flex;
  flex-direction:column;
  min-height:0;
}

/* Touch devices: allow native panning in both directions. */
#viewport{ touch-action: pan-x pan-y; }

/* Desktop: we handle drag-to-pan. */
@media (hover:hover) and (pointer:fine){
  #viewport{ touch-action:none; }
}

#viewport{
  width:100%;
  flex:1 1 auto;
  min-height:0;
  border:2px solid #000;
  background:transparent;
  outline:none;
  position:relative;
}
#viewport:focus-visible{ outline:2px solid #000; outline-offset:3px; }

#canvas{
  width: max(220%, 900px);
  height: max(220%, 900px);
  position:relative;
  background:transparent;
}
#canvas img{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover;
  pointer-events:none;
  user-select:none;
  -webkit-user-drag:none;
}

@media (hover:hover) and (pointer:fine){
  #viewport{ cursor:grab; }
  #viewport.isGrabbing{ cursor:grabbing; }
}

#homeOverlay{
  margin-top:10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.caption{
  max-width:420px;
  background:#fff;
  border:2px solid #000;
  padding:6px 8px;
  font-size:11px;
  line-height:1.2;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.pager{display:flex;gap:6px}
.pbtn{
  width:34px;height:28px;display:grid;place-items:center;
  background:var(--paper2);
  border:2px solid;
  border-color:var(--hi) var(--deep) var(--deep) var(--hi);
  box-shadow:var(--shadow);
  cursor:pointer; user-select:none;
  color:#000;
  font-family:inherit;
}
.pbtn:active{transform:translate(1px,1px)}

/* =========================================================
   CSS: CONTENT PAGES
========================================================= */
.list{
  width:100%;
  height:100%;
  margin:0;
  background:#fff;
  border:2px solid #000;
  padding:14px 14px 16px;
  font-size:13px;
  line-height:1.2;
  box-shadow:var(--shadow);

  display:flex;
  flex-direction:column;
  min-height:0;
}

.pageScroll{ flex:1 1 auto; min-height:0; }

.pageInner{
  width:max-content;
  min-width:100%;
  padding-right:18px;
  padding-bottom:14px;
}

.list h2{
  margin:0 0 8px;
  font-size:14px;
  letter-spacing:.08em;
}

.rule{
  height:2px;
  background:#000;
  margin:0 0 14px;
}
.spacer{height:14px}

.items{ margin-top:10px; width:max-content; min-width:100% }

.item{
  padding:6px 0;
  border-top:1px solid rgba(0,0,0,.14);
  font-variant-numeric: tabular-nums;
}
.item:first-child{border-top:0}
.pathRow{display:flex;align-items:baseline;gap:0;white-space:nowrap}
.prompt{opacity:.95}
.promptLine{display:flex;align-items:baseline;gap:0;white-space:nowrap}
.titleCell{white-space:nowrap}
.sep{opacity:.9; margin:0 4px;}
.metaLine{white-space:nowrap}

.list a, .caption a{
  color:#1f4f8a;
  text-decoration:none;
  -webkit-tap-highlight-color: transparent;
}
.list a:visited, .caption a:visited{ color:#1f4f8a; }
.list a:focus, .caption a:focus{
  outline:2px solid #000;
  outline-offset:2px;
}

em{font-style:italic}
.q{ quotes: "“" "”" "‘" "’"; }
.q::before{ content: open-quote; }
.q::after{ content: close-quote; }

/* CONTACT: no scroll; wrap within the box */
#p-contact .list{ overflow:hidden; }
#p-contact p{ white-space:normal; overflow-wrap:anywhere; }

/* =========================================================
   CSS: BLOG — HEADER TOOLS + LED
========================================================= */
.notesHdr{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.notesTools{ display:flex; gap:8px; }
.notesMiniBtn{
  width:26px;
  height:20px;
  background:#c4c4c4;
  border:1px solid #000;
  box-shadow:var(--shadow);
  cursor:pointer;
  padding:0;
  display:grid;
  place-items:center;
  font-size:14px;
  line-height:1;
  color:#000;
  font-family:inherit;
}
.notesMiniBtn:active{ transform:translate(1px,1px); }
.notesMiniBtn.isOn{
  background: var(--accent);
  border-color: var(--deep) var(--hi) var(--hi) var(--deep);
}

.led{
  display:inline-block;
  width:7px;
  height:7px;
  border:1px solid #000;
  margin-right:8px;
  vertical-align:middle;
  box-shadow:var(--shadow);
}

/* BLOG: keep ">" aligned AND keep LED fully visible */
#p-notes .pathRow .promptLine{
  position:relative;
  padding-left:18px;
}
#p-notes .pathRow .promptLine .led{
  position:absolute;
  left:0;
  top:50%;
  transform:translateY(-50%);
  margin:0;
}

/* LED colors */
.led-zine{ background:#990066; }
.led-video{ background:#FF6600; }
.led-photo{ background:#fdfb8c; }
.led-pdf{ background:#ffffff; }
.led-article{ background:#669900; }
.led-other{ background:#777; }

/* =========================================================
   CSS: DIALOGS (TimeQuotes + Notes + About)
========================================================= */
#timeDialog, #noteDialog, #aboutDialog{
  border:0;
  padding:0;
  background:transparent;
}
#timeDialog::backdrop, #noteDialog::backdrop, #aboutDialog::backdrop{
  background:rgba(0,0,0,.35);
}
/* DIALOG OVERLAYS: always full-screen; center inner window reliably */
#timeDialog[open], #noteDialog[open], #aboutDialog[open]{
  position:fixed;
  inset:0;
  margin:0;
  padding:0;
  width:auto;
  height:auto;
  max-height:none;

  display:flex;
  align-items:center;
  justify-content:center;
}

/* Size is on the inner window (prevents centering drift when content changes) */
#timeDialog .tqModal, #noteDialog .tqModal, #aboutDialog .tqModal{
  width:min(1200px, 92vw);
  max-height:92vh;
}

.tqModal{
  background:#000;
  border:2px solid #000;
  box-shadow:var(--shadow);
  padding:14px 14px 12px;
  overflow:auto;
  max-height:92vh;
}
.tqBar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  margin-bottom:12px;
}

.tqTitle{
  font-weight:900;
  font-size:14px;
  letter-spacing:.02em;
  color:#fff;
}
.tqIdx{
  margin-left:18px;
  font-weight:300;
  font-size:11px;
  color:#fff;
  opacity:.7;
}
.tqNav{display:flex;align-items:center;gap:10px}
.tqNavBtn{
  width:40px;
  height:25px;
  background:#c4c4c4;
  border:1px solid #000;
  box-shadow:var(--shadow);
  cursor:pointer;
  font-family:inherit;
  font-weight:900;
}
.tqCloseBtn{
  width:40px;
  height:25px;
  background:#c4c4c4;
  border:1px solid #000;
  box-shadow:var(--shadow);
  cursor:pointer;
  font-size:22px;
  line-height:1;
  padding:0;
  display:grid;
  place-items:center;
}

.tqNavBtn:active, .tqCloseBtn:active{ transform:translate(1px,1px); }

.tqNavBtn[disabled]{ opacity:.45; cursor:default; }
.tqNavBtn[disabled]:active{ transform:none; }

/* =========================================================
   ABOUT: mobile layout polish
========================================================= */
#aboutDialog .tqQuoteBox{
  padding:16px 18px;
}

@media (max-width: 600px){
  #aboutDialog[open]{
    width:96vw;
    max-height:94svh;
  }
  #aboutDialog .tqModal{
    padding:10px;
    max-height:94svh;
  }
  #aboutDialog .tqBar{
    gap:10px;
  }
  #aboutDialog .tqTitle{
    font-size:13px;
  }
  #aboutDialog .tqQuoteBox{
    padding:12px 12px;
  }
}

/* NOTE MODAL HEADER: prev/led/next on the left */
.noteBar{ justify-content:space-between; }

/* =========================================================
   NOTES (IMAGE VIEWER): STABLE LAYOUT (NO JS HEIGHT MATH)
   - Modal becomes a column: header + content
   - Image notes become a 2-row grid: image (1fr) + caption (auto)
   Ensures image + caption always visible without clipping.
========================================================= */
#noteDialog .tqModal{
  display:flex;
  flex-direction:column;
  overflow:hidden; /* scrolling is managed inside content as needed */
}

/* Image notes: reserve caption row; image uses remaining space */
#noteDialog .noteFrameWrap.isImg{
  background:#000;
  display:grid;
  grid-template-rows: minmax(0, 1fr) auto;
  gap:0;
  overflow:hidden;
  min-height:0;
}

#noteDialog .noteFrameWrap.isImg #noteImg{
  justify-self:stretch;
  align-self:stretch;
  width:100%;
  height:100%;
  max-width:100%;
  max-height:100%;
  object-fit:contain;
  background:#000;
  margin:0;
  display:block;
}

.noteNavLeft{
  display:flex;
  align-items:center;
  gap:10px;
  flex:0 0 auto;
}
#noteDialog .noteNavLeft .led{
  width:10px;
  height:10px;
  margin:0;
  box-shadow:var(--shadow);
}

.noteCaption{
  border-top:2px solid #000;
  background:#000;
  color:#9a9a9a;
  padding:10px 10px calc(10px + env(safe-area-inset-bottom));
  font-size:10px;
  line-height:1.25;
  white-space:normal;
  overflow-wrap:anywhere;
}

.tqQuoteBox{
  border:2px solid #000;
  padding:16px 18px;
  background:#fff;
}
.tqQuote{
  font-size:12px;
  line-height:1.15;
  font-family:var(--mono);
  white-space:pre-wrap;
}
.tqMeta{
  margin-top:12px;
  font-size:12px;
  font-family:var(--mono);
  color:#555;
}

/* notes frame container (PDFs + embeds + articles) */
.noteFrameWrap{
  border:2px solid #000;
  background:#fff;

  /* This area is the "content pane" under the bar. */
  flex:1 1 auto;
  min-height:0;

  /* Let the embedded viewer handle scrolling; prevents double-scroll + clipping. */
  overflow:hidden;
  display:flex;
  flex-direction:column;
}

/* Non-image viewers fill the pane */
#noteFrame, #notePdf{
  flex:1 1 auto;
  min-height:0;
  width:100%;
  height:100%;
  border:0;
  display:block;
  background:#fff;
}

@media (max-width:420px){
  :root{--btn:48px}
  .glyph{font-size:28px}
  .caption{max-width:70%;font-size:10px}
  .tqTitle{font-size:18px}
  .tqNavBtn{width:66px;height:52px}
  .tqCloseBtn{width:110px;height:52px}
  .tqQuote, .tqMeta{font-size:16px}
  }

/* ASCII in About module */
#aboutModule pre.ascii,
.aboutmodule pre.ascii,
.aboutModule pre.ascii{
  font-family: var(--mono, ui-monospace, Menlo, Monaco, Consolas, monospace);
  font-size: 8px;
  line-height: 1.0;
  white-space: pre;
  margin: 0;
  overflow: hidden;
}

#aboutText pre.ascii{
  background:#000;
  color:#ddd;
  padding:10px;
  margin:0;
  white-space:pre;
  overflow:auto;
  max-height:60vh;
}

#aboutModule pre.ascii.ascii-color span{ white-space: pre; }

/* =========================================================
   MOBILE: WINDOW MANAGER DIALOGS (floating, consistent)
========================================================= */
body.modalOpen{ overflow:hidden; }

@media (max-width:700px){
  #timeDialog[open], #noteDialog[open], #aboutDialog[open]{
    position:fixed;
    inset:0;
    margin:0;
    width:100vw;
    height:100svh;
    max-height:none;
    padding:
      calc(14px + env(safe-area-inset-top))
      calc(14px + env(safe-area-inset-right))
      calc(14px + env(safe-area-inset-bottom))
      calc(14px + env(safe-area-inset-left));
    display:flex;
    align-items:center;
    justify-content:center;
  }

  #timeDialog .tqModal, #noteDialog .tqModal, #aboutDialog .tqModal{
    position:relative;
    left:auto;
    top:auto;
    transform:none;
    margin:0;
    margin-top:-3svh;
    width:min(520px, 94vw);
    max-height:82svh;

    padding:10px;
    overflow:hidden;
  }

  #timeDialog .tqTitle, #aboutDialog .tqTitle, #noteDialog .tqTitle{
    font-size:12px;
    letter-spacing:.06em;
  }
  #timeDialog .tqIdx, #aboutDialog .tqIdx{
    font-size:10px;
    opacity:.75;
    margin-left:10px;
  }
  #timeDialog .tqBar, #aboutDialog .tqBar, #noteDialog .tqBar{
    gap:10px;
    margin-bottom:10px;
  }

  .tqNavBtn, .tqCloseBtn{
    width:44px;
    height:44px;
    padding:0;
    background:transparent;
    border:0;
    box-shadow:none;
    position:relative;
    cursor:pointer;
    font-family:inherit;
    font-weight:900;
    display:grid;
    place-items:center;
    color:#000;
    font-size:16px;
    line-height:1;
    -webkit-tap-highlight-color: transparent;

    z-index:0;
    isolation:isolate;
  }
  .tqNavBtn::before, .tqCloseBtn::before{
    content:"";
    position:absolute;
    left:50%;
    top:50%;
    width:34px;
    height:24px;
    transform:translate(-50%,-50%);
    background:#c4c4c4;
    border:1px solid #000;
    box-shadow:var(--shadow);
    z-index:-1;
  }
  .tqCloseBtn{ font-size:18px; }
  .tqNavBtn:active::before, .tqCloseBtn:active::before{
    transform:translate(calc(-50% + 1px), calc(-50% + 1px));
  }

  #timeDialog .tqQuoteBox,
  #aboutDialog .tqQuoteBox,
  #noteDialog .noteFrameWrap{
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    max-height:calc(82svh - 64px);
  }

  #timeDialog .tqQuote, #aboutDialog .tqQuote{
    font-size:12px;
    line-height:1.25;
  }
  #timeDialog .tqMeta{
    font-size:11px;
    line-height:1.25;
  }

  #aboutDialog #aboutText.tqQuote{
    font-size:12px;
    line-height:1.25;
  }
  #aboutDialog .tqQuoteBox{ padding:12px; }

  
  #noteDialog .noteFrameWrap.isImg{
    background:#000;
    display:grid;
    grid-template-rows: minmax(0, 1fr) auto;
    gap:0;
    overflow:hidden;
    min-height:0;
  }
  #noteDialog .noteFrameWrap.isImg #noteImg{
    justify-self:center;
    align-self:center;
    width:auto;
    height:auto;
    max-width:100%;
    max-height:100%;
    object-fit:contain;
    background:#000;
    margin:0;
    display:block;
  }
  #noteDialog .noteFrameWrap.isImg.isFill #noteImg{
    object-fit:contain;
  }

  .noteCaption{
    font-size:10px;
    line-height:1.25;
  }

  .notePdfMobile{
    padding:14px 12px;
  }
}

/* Keep consistent YouTube sizing (desktop + mobile) */
.noteFrameWrap.isVideo{
  background:#000;
}
.noteFrameWrap.isVideo #noteFrame{
  width:100%;
  aspect-ratio:16 / 9;
  height:auto;
  max-height:min(70vh, 720px);
  background:#000;
}

/* =========================================================
   PDF MOBILE PANEL: icon button (terminal-clean)
========================================================= */
.notePdfMobile{
  border:2px solid #000;
  background:#fff;
  padding:16px 14px;
  display:grid;
  grid-template-columns:1fr auto; /* title left, icon right */
  align-items:center;
  gap:10px;
}

.notePdfMobile .pdfTitle{
  font-weight:900;
  font-size:12px;
  line-height:1.1;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* hit area (44) with a small keycap face inside */
.noteOpenBtn{
  width:44px;
  height:44px;
  padding:0;
  background:transparent;
  border:0;
  box-shadow:none;
  cursor:pointer;
  user-select:none;
  position:relative;
  display:grid;
  place-items:center;
  font-family:var(--mono);
  color:#000;
  -webkit-tap-highlight-color: transparent;
  isolation:isolate;
}

.noteOpenBtn::before{
  content:"";
  position:absolute;
  left:50%;
  top:50%;
  width:34px;
  height:24px;
  transform:translate(-50%,-50%);
  background:#c4c4c4;
  border:1px solid #000;
  box-shadow:var(--shadow);
  z-index:-1;
}

.noteOpenBtn:active::before{
  transform:translate(calc(-50% + 1px), calc(-50% + 1px));
}

.noteOpenBtn .ico{
  display:block;
  font-size:16px;
  line-height:1;
  font-weight:900;
}

</style>
</head>

<body>
<div class="frame" id="root">
  <aside class="win" aria-label="Sidebar">
    <a class="nameBtn" id="linkHomeTop" href="#/home" data-route="home" title="Home" aria-label="Home">Christian N. Kerr</a>

    <div class="controls">
      <div class="btns" aria-label="Navigation">
        <a class="btn" id="linkNotes" href="#/notes" data-route="notes" title="Blog" aria-label="Blog"><div class="glyph">博</div></a>
        <a class="btn" id="linkWriting"  href="#/writing"  data-route="writing"  title="Clips"  aria-label="Clips"><div class="glyph">刊</div></a>
        <a class="btn" id="linkResearch" href="#/research" data-route="research" title="Research" aria-label="Research"><div class="glyph">研</div></a>
        <a class="btn" id="linkContact"  href="#/contact"  data-route="contact"  title="Contact" aria-label="Contact"><div class="glyph">联</div></a>
      </div>

      <button class="clockBtn" id="clockBtn" type="button" aria-label="Current date and time">
        <div class="clockLine" id="clockStamp">—</div>
      </button>
    </div>
  </aside>

  <main class="stage" id="stage" aria-label="Stage">
    <!-- HOME -->
    <section class="panel" id="p-home">
      <div class="win wrap" id="homeWrap">
        <div class="viewport scrollbox" id="viewport" tabindex="0" aria-label="Artwork viewer (drag or click to pan)">
          <div class="canvas" id="canvas">
            <img id="hero" src="" alt="" draggable="false" decoding="async" fetchpriority="high">
          </div>
        </div>

        <div class="overlayRow" id="homeOverlay" aria-label="Image controls">
          <div class="caption" id="caption">—</div>
          <div class="pager">
            <button class="pbtn" id="prev" type="button" aria-label="Previous image" title="Previous">◀</button>
            <button class="pbtn" id="next" type="button" aria-label="Next image" title="Next">▶</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CLIPS -->
    <section class="panel" id="p-writing">
      <div class="list">
        <div class="pageScroll scrollbox" id="scroll-writing">
          <div class="pageInner">
            <h2>CLIPS</h2>
            <div class="rule"></div>
            <div class="items" id="items-writing" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- RESEARCH -->
    <section class="panel" id="p-research">
      <div class="list">
        <div class="pageScroll scrollbox" id="scroll-researchAll">
          <div class="pageInner">
            <h2>RESEARCH</h2>
            <div class="rule"></div>
            <div class="items" id="items-research" aria-live="polite"></div>

            <div class="spacer"></div>

            <h2>FACT-CHECKING</h2>
            <div class="rule"></div>
            <div class="items" id="items-factChecking" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- BLOG -->
    <section class="panel" id="p-notes">
      <div class="list">
        <div class="pageScroll scrollbox" id="scroll-notes">
          <div class="pageInner">
            <div class="notesHdr">
              <h2>BLOG</h2>
              <div class="notesTools" aria-label="Blog sorting controls">
                <button id="notesSortDate" class="notesMiniBtn" type="button" aria-label="Sort by date">↕</button>
                <button id="notesSortType" class="notesMiniBtn" type="button" aria-label="Sort by type">≡</button>
              </div>
            </div>
            <div class="rule"></div>
            <div class="items" id="items-notes" aria-live="polite"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- CONTACT -->
<section class="panel" id="p-contact">
  <div class="list">
    <div class="pageScroll scrollbox">
      <div class="pageInner">
        <h2>CONTACT</h2>
        <div class="rule"></div>
        <p>
          Location: Brooklyn, New York, USA<br>
          Email: <a href="mailto:christian.n.kerr@gmail.com">christian.n.kerr@gmail.com</a><br>
          Socials:
          <a href="https://www.youtube.com/@CNKERR..." target="_blank" rel="noopener">YouTube</a>,
          <a href="https://x.com/cnkerr" target="_blank" rel="noopener">X</a>,
          <a href="https://www.instagram.com/cnkerr" target="_blank" rel="noopener">Instagram</a><br>

          Resumé: <a href="assets/kerr_christian_cv.pdf" target="_blank" rel="noopener">kerr_christian_cv</a>
        </p>
        <p class="quote" style="color:#838383; font-size:8px; line-height:1.25;">
          "I celebrate myself, and sing myself,<br>And what I assume you shall assume,<br>For every atom belonging to me as good belongs to you." <br>—WW
        </p>
      </div>
    </section>
  </main>
</div>

<!-- TIMEQUOTES dialog -->
<dialog id="timeDialog" aria-label="Time quotes">
  <div class="tqModal">
    <div class="tqBar">
      <div class="tqTitle">
        Time? <span class="tqIdx" id="timeIdx">00/00</span>
      </div>
      <div class="tqNav">
        <button class="tqNavBtn" id="timePrev" type="button" aria-label="Previous quote">&lt;</button>
        <button class="tqNavBtn" id="timeNext" type="button" aria-label="Next quote">&gt;</button>
        <button class="tqCloseBtn" id="timeClose" type="button" aria-label="Close">x</button>
      </div>
    </div>

    <div class="tqQuoteBox" aria-live="polite">
      <div class="tqQuote" id="timeQuoteText">—</div>
      <div class="tqMeta" id="timeQuoteMeta">—</div>
    </div>
  </div>
</dialog>

<!-- ABOUT dialog -->
<dialog id="aboutDialog" aria-label="About this site">
  <div class="tqModal">
    <div class="tqBar">
      <div class="tqTitle" id="aboutTitle"></div>

      <div class="tqNav">
        <button class="tqNavBtn" id="aboutPrev" type="button" aria-label="Previous slide">&lt;</button>
        <button class="tqNavBtn" id="aboutNext" type="button" aria-label="Next slide">&gt;</button>
        <button class="tqCloseBtn" id="aboutClose" type="button" aria-label="Close">x</button>
      </div>
    </div>

    <div class="tqQuoteBox" aria-live="polite">
      <div class="tqQuote" id="aboutText">—</div>
    </div>
  </div>
</dialog>

<!-- NOTES dialog -->
<dialog id="noteDialog" aria-label="Note">
  <div class="tqModal">
    <div class="tqBar noteBar">
      <div class="noteNavLeft" aria-label="Blog navigation">
        <button class="tqNavBtn" id="notePrev" type="button" aria-label="Previous">&lt;</button>
        <span id="noteTypeLed" class="led led-other" aria-hidden="true"></span>
        <button class="tqNavBtn" id="noteNext" type="button" aria-label="Next">&gt;</button>
      </div>

      <div class="tqNav noteNavRight">
        <button class="tqCloseBtn" id="notePop" type="button" aria-label="Open in new tab">❒</button>
        <button class="tqCloseBtn" id="noteClose" type="button" aria-label="Close">x</button>
      </div>
    </div>

    <div class="noteFrameWrap" aria-live="polite">
      <img id="noteImg" alt="" hidden>

      <iframe
        id="noteFrame"
        title="Note"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen
        referrerpolicy="strict-origin-when-cross-origin"
      ></iframe>

      <embed id="notePdf" type="application/pdf" hidden>

      <div id="notePdfMobile" class="notePdfMobile" hidden>
        <div class="pdfTitle" id="notePdfMobileTitle">PDF</div>
        <button class="noteOpenBtn" id="notePdfMobileBtn" type="button"
                aria-label="Open PDF in new tab" title="Open PDF">
          <span class="ico" aria-hidden="true">⧉</span>
        </button>
      </div>

      <div id="noteCaption" class="noteCaption" hidden></div>
    </div>
  </div>
</dialog>

<script>
/* =========================================================
   JS: BOOTSTRAP (loads data.js then starts)
========================================================= */
(function loadDataThenBoot(){
  function boot(){
    var $ = function(id){ return document.getElementById(id); };

    function esc(s){
      return String(s == null ? "" : s).replace(/[&<>"']/g, function(m){
        return ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" })[m];
      });
    }

    // -------------------------------------------------------
    // JS: DATA (safe fallback)
    // -------------------------------------------------------
    var DATA = (window.DATA_REMOTE && typeof window.DATA_REMOTE === "object")
      ? window.DATA_REMOTE
      : { slides:[], writing:[], research:[], factChecking:[], timeQuotes:[], notes:[], aboutSlides: [] };

    function ensureArrayKey(obj, key){
      if (!obj || !Array.isArray(obj[key])) obj[key] = [];
    }
    ensureArrayKey(DATA, "slides");
    ensureArrayKey(DATA, "writing");
    ensureArrayKey(DATA, "research");
    ensureArrayKey(DATA, "factChecking");
    ensureArrayKey(DATA, "timeQuotes");
    ensureArrayKey(DATA, "notes");
    ensureArrayKey(DATA, "aboutSlides");

    var prefersReducedMotion = !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);

    function isCoarsePointer(){
      return !!(window.matchMedia && window.matchMedia("(pointer: coarse)").matches);
    }
    function isMobileDialog(){
      return !!(window.matchMedia && window.matchMedia("(max-width:700px)").matches) || isCoarsePointer();
    }
    function setBodyModalOpen(on){
      document.body.classList.toggle("modalOpen", !!on);
    }

    // -------------------------------------------------------
    // JS: HOME VIEWER PAN
    // -------------------------------------------------------
    var viewport = $("viewport");
    var canvas = $("canvas");
    var hero = $("hero");

    function isHomeActive(){
      var p = $("p-home");
      return !!(p && p.classList.contains("isActive"));
    }

    function panCenter(){
      if (!viewport || !canvas) return;
      var maxX = Math.max(0, canvas.scrollWidth  - viewport.clientWidth);
      var maxY = Math.max(0, canvas.scrollHeight - viewport.clientHeight);
      viewport.scrollTo({ left: maxX * 0.5, top: maxY * 0.5, behavior:(prefersReducedMotion?"auto":"smooth") });
    }

    /* Keep the huge pan-canvas feel on mobile, but prevent “permanent crop”:
       resize the canvas to the slide’s aspect ratio (bigger than viewport in both axes). */
    function setCanvasForSlide(){
      if (!viewport || !canvas || !hero) return;
      if (!hero.naturalWidth || !hero.naturalHeight) return;

      var vw = viewport.clientWidth || 0;
      var vh = viewport.clientHeight || 0;
      if (!vw || !vh) return;

      var r = hero.naturalWidth / hero.naturalHeight;

      // Drive by the larger of (2.2x viewport) and 900px, then ensure both axes are “huge”.
      var targetW = Math.max(Math.floor(vw * 2.2), 900);
      var targetH = Math.floor(targetW / r);

      var minHugeH = Math.max(Math.floor(vh * 2.2), 900);
      if (targetH < minHugeH){
        targetH = minHugeH;
        targetW = Math.floor(targetH * r);
      }

      canvas.style.width  = targetW + "px";
      canvas.style.height = targetH + "px";

      requestAnimationFrame(panCenter);
    }

    (function enableHomePan(){
      if (!viewport) return;
      var fine = window.matchMedia && window.matchMedia("(hover:hover) and (pointer:fine)").matches;
      if (!fine) return;

      var isDown = false;
      var moved = false;
      var startX = 0, startY = 0;
      var startSL = 0, startST = 0;
      var raf = 0;
      var lastX = 0, lastY = 0;

      function applyMove(){
        raf = 0;
        if (!isDown) return;
        var dx = lastX - startX;
        var dy = lastY - startY;
        viewport.scrollLeft = startSL - dx;
        viewport.scrollTop  = startST - dy;
      }

      viewport.addEventListener("pointerdown", function(e){
        if (!isHomeActive()) return;
        if (e.pointerType && e.pointerType !== "mouse" && e.pointerType !== "pen") return;
        if (e.button != null && e.button !== 0) return;

        isDown = true;
        moved = false;

        startX = e.clientX; startY = e.clientY;
        lastX = startX; lastY = startY;

        startSL = viewport.scrollLeft;
        startST = viewport.scrollTop;

        viewport.classList.add("isGrabbing");
        viewport.setPointerCapture(e.pointerId);

        e.preventDefault();
      }, { passive:false });

      viewport.addEventListener("pointermove", function(e){
        if (!isDown) return;
        lastX = e.clientX; lastY = e.clientY;

        if (!moved){
          if (Math.abs(lastX - startX) > 3 || Math.abs(lastY - startY) > 3) moved = true;
        }
        if (!raf) raf = requestAnimationFrame(applyMove);
      });

      function endDrag(e){
        if (!isDown) return;
        isDown = false;
        viewport.classList.remove("isGrabbing");
        try{ viewport.releasePointerCapture(e.pointerId); }catch(_){}
      }

      viewport.addEventListener("pointerup", endDrag);
      viewport.addEventListener("pointercancel", endDrag);
      viewport.addEventListener("lostpointercapture", function(){
        isDown = false;
        viewport.classList.remove("isGrabbing");
      });

      viewport.addEventListener("click", function(e){
        if (!isHomeActive()) return;
        if (moved) return;

        var rect = viewport.getBoundingClientRect();
        var x = e.clientX - rect.left + viewport.scrollLeft;
        var y = e.clientY - rect.top  + viewport.scrollTop;

        viewport.scrollTo({
          left: x - viewport.clientWidth/2,
          top:  y - viewport.clientHeight/2,
          behavior:(prefersReducedMotion?"auto":"smooth")
        });
      });
    })();

    // -------------------------------------------------------
    // JS: HOME SLIDESHOW
    // -------------------------------------------------------
    var cap = $("caption");
    var prevBtn = $("prev");
    var nextBtn = $("next");

    var slideIndex = Number(localStorage.getItem("slideIndex") || 0) || 0;
    var slides = DATA.slides;

    function setHomeEmptyState(msg){
      if (hero) hero.removeAttribute("src");
      if (hero) hero.alt = "";
      if (cap) cap.textContent = msg || "—";
    }

    function showSlide(n){
      if (!slides.length){
        setHomeEmptyState("No slides yet (add DATA_REMOTE.slides in data.js).");
        if (prevBtn) prevBtn.disabled = true;
        if (nextBtn) nextBtn.disabled = true;
        return;
      }
      if (prevBtn) prevBtn.disabled = false;
      if (nextBtn) nextBtn.disabled = false;

      slideIndex = (n + slides.length) % slides.length;
      var s = slides[slideIndex] || {};
      var src = String(s.src || "").trim();
      var caption = String(s.caption || "").trim();

      if (!src){
        setHomeEmptyState("Slide missing src (check DATA_REMOTE.slides).");
        return;
      }

      if (hero){
        hero.onload = function(){
          setCanvasForSlide();
        };
        hero.src = src;
        hero.alt = caption || "";
      }
      if (cap) cap.textContent = caption || "—";

      localStorage.setItem("slideIndex", String(slideIndex));
    }

    if (prevBtn) prevBtn.addEventListener("click", function(){ showSlide(slideIndex - 1); });
    if (nextBtn) nextBtn.addEventListener("click", function(){ showSlide(slideIndex + 1); });

    window.addEventListener("resize", function(){
      setCanvasForSlide();
    });

    // -------------------------------------------------------
    // JS: CLOCK
    // -------------------------------------------------------
    var clockStamp = $("clockStamp");
    function tick(){
      if (!clockStamp) return;
      var now = new Date();
      var parts = new Intl.DateTimeFormat("en-US", {
        timeZone: "America/New_York",
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      }).formatToParts(now);

      function get(t){
        for (var i=0;i<parts.length;i++){
          if (parts[i].type === t) return parts[i].value;
        }
        return "00";
      }
      clockStamp.textContent =
        get("year") + "." + get("month") + "." + get("day") +
        "T" + get("hour") + ":" + get("minute") + ":" + get("second") + ":ET";
    }
    tick();
    setInterval(tick, 1000);

    // -------------------------------------------------------
    // JS: LIST HELPERS + RENDER
    // -------------------------------------------------------
    function parseMonthYear(s){
      var str = String(s || "").trim();
      var m = str.match(/^([A-Za-z]{3,})\s+(\d{4})$/);
      if (!m) return 0;
      var mon = m[1].slice(0,3).toLowerCase();
      var year = Number(m[2]);
      var months = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
      if (!months.hasOwnProperty(mon) || !Number.isFinite(year)) return 0;
      return new Date(year, months[mon], 1).getTime();
    }

    function authorPublisherHtml(s){
      var str = String(s || "").trim();
      var m = str.match(/^(.*)\s+\(([^)]+)\)\s*$/);
      if (!m) return esc(str);
      var author = esc(m[1].trim());
      var pub = esc(m[2].trim());
      return author + " (<em>" + pub + "</em>)";
    }

    function row1(titleHtml, metaHtml, prefixHtml){
      var metaPart = metaHtml ? ('<span class="sep"> / </span><span class="metaLine">' + metaHtml + '</span>') : "";
      var prefix = prefixHtml ? prefixHtml : "";
      return (
        '<div class="item">' +
          '<div class="pathRow">' +
            '<div class="promptLine">' +
              prefix +
              '<span class="prompt">&gt;</span>' +
              '<span class="titleCell">' + titleHtml + '</span>' +
            '</div>' +
            metaPart +
          '</div>' +
        '</div>'
      );
    }

    function render(section){
      var out = $("items-" + section);
      if (!out) return;

      var items = (DATA[section] || []).slice();
      items.sort(function(a,b){
        if (section === "factChecking") return parseMonthYear(b.date) - parseMonthYear(a.date);
        return (b.year || 0) - (a.year || 0);
      });

      if (!items.length){
        out.innerHTML = row1("No items yet.", "");
        return;
      }

      if (section === "writing"){
        var htmlW = [];
        for (var i=0;i<items.length;i++){
          var it = items[i] || {};
          var title = esc(it.title || "");
          var href = it.url ? String(it.url) : "";
          var titleHtml = href
            ? ('<a href="' + esc(href) + '" target="_blank" rel="noopener">' + title + '</a>')
            : title;

          var pub = it.outlet ? ("<em>" + esc(it.outlet) + "</em>") : "";
          var year = it.year ? esc(it.year) : "";
          var metaHtml = [pub, year].filter(Boolean).join(" / ");
          htmlW.push(row1(titleHtml, metaHtml));
        }
        out.innerHTML = htmlW.join("");
        return;
      }

      if (section === "research"){
        var htmlR = [];
        for (var j=0;j<items.length;j++){
          var it2 = items[j] || {};
          var raw = esc(it2.title || "");
          var inner = it2.italic ? ("<em>" + raw + "</em>") : raw;
          var href2 = it2.url ? String(it2.url) : "";
          var titleHtml2 = href2
            ? ('<a href="' + esc(href2) + '" target="_blank" rel="noopener">' + inner + '</a>')
            : inner;

          var ap = it2.outlet ? authorPublisherHtml(it2.outlet) : "";
          var year2 = it2.year ? esc(it2.year) : "";
          var metaHtml2 = [ap, year2].filter(Boolean).join(" / ");
          htmlR.push(row1(titleHtml2, metaHtml2));
        }
        out.innerHTML = htmlR.join("");
        return;
      }

      // factChecking
      var htmlF = [];
      for (var k=0;k<items.length;k++){
        var it3 = items[k] || {};
        var titleQuoted = '<span class="q">' + esc(it3.title || "") + '</span>';
        var href3 = it3.url ? String(it3.url) : "";
        var titleHtml3 = href3
          ? ('<a href="' + esc(href3) + '" target="_blank" rel="noopener">' + titleQuoted + '</a>')
          : titleQuoted;

        var author = esc(it3.author || "");
        var pub3 = it3.publication ? ("<em>" + esc(it3.publication) + "</em>") : "";
        var ap3 = (author && pub3) ? (author + " (" + pub3 + ")") : (author || (pub3 ? ("(" + pub3 + ")") : ""));
        var date3 = esc(it3.date || "");
        var metaHtml3 = [ap3, date3].filter(Boolean).join(" / ");
        htmlF.push(row1(titleHtml3, metaHtml3));
      }
      out.innerHTML = htmlF.join("");
    }

    // -------------------------------------------------------
    // JS: BLOG (NOTES)
    // -------------------------------------------------------
    var itemsNotes   = $("items-notes");
    var noteDialog   = $("noteDialog");
    var noteClose    = $("noteClose");
    var noteFrame    = $("noteFrame");
    var notePdf      = $("notePdf");
    var noteImg      = $("noteImg");
    var notePop      = $("notePop");
    var noteCaption  = $("noteCaption");

    var notePdfMobile = $("notePdfMobile");
    var notePdfMobileTitle = $("notePdfMobileTitle");
    var notePdfMobileBtn = $("notePdfMobileBtn");

    var notePrevBtn  = $("notePrev");
    var noteNextBtn  = $("noteNext");
    var noteTypeLed  = $("noteTypeLed");

    var notesKeyToIndex = new Map();
    var suppressHashReopen = false;

    var notesSortDateBtn = $("notesSortDate");
    var notesSortTypeBtn = $("notesSortType");

    var notesSortMode = localStorage.getItem("notesSortMode") || "date";
    var notesSortDateDir = Number(localStorage.getItem("notesSortDateDir") || -1);
    var notesSortTypeDir = Number(localStorage.getItem("notesSortTypeDir") || 1);

    function updateNotesSortUI(){
      if (notesSortDateBtn){
        notesSortDateBtn.classList.toggle("isOn", notesSortMode === "date");
        notesSortDateBtn.title = (notesSortDateDir < 0) ? "Date: newest → oldest" : "Date: oldest → newest";
      }
      if (notesSortTypeBtn){
        notesSortTypeBtn.classList.toggle("isOn", notesSortMode === "type");
        notesSortTypeBtn.title = (notesSortTypeDir > 0) ? "Type: A → Z (within type: newest first)" : "Type: Z → A (within type: newest first)";
      }
    }

    if (notesSortDateBtn){
      notesSortDateBtn.addEventListener("click", function(){
        if (notesSortMode !== "date") notesSortMode = "date";
        else notesSortDateDir *= -1;

        localStorage.setItem("notesSortMode", notesSortMode);
        localStorage.setItem("notesSortDateDir", String(notesSortDateDir));
        updateNotesSortUI();
        renderNotesList();
      });
    }

    if (notesSortTypeBtn){
      notesSortTypeBtn.addEventListener("click", function(){
        if (notesSortMode !== "type") notesSortMode = "type";
        else notesSortTypeDir *= -1;

        localStorage.setItem("notesSortMode", notesSortMode);
        localStorage.setItem("notesSortTypeDir", String(notesSortTypeDir));
        updateNotesSortUI();
        renderNotesList();
      });
    }

    function resetNoteDialogSizing(){
      if (!noteDialog) return;
      noteDialog.style.width = "";
      noteDialog.style.height = "";
      noteDialog.style.maxWidth = "";
      noteDialog.style.maxHeight = "";
      if (noteImg){
        noteImg.style.width = "";
        noteImg.style.height = "";
        noteImg.style.objectFit = "";
      }

      var modal = noteDialog.querySelector(".tqModal");
      var wrap = noteDialog.querySelector(".noteFrameWrap");
      if (modal){
        modal.style.width = "";
        modal.style.height = "";
        modal.style.maxHeight = "";
      }
      if (wrap){
        wrap.style.maxHeight = "none";
        wrap.style.overflow = "";
        wrap.style.height = "";
      }
    }

    function sizeDialogToImage(img){
      if (!noteDialog || !img || !img.naturalWidth || !img.naturalHeight) return;

      // Mobile/fullscreen dialogs: let CSS drive layout.
      if (typeof isMobileDialog === "function" && isMobileDialog()){
        img.style.width = "100%";
        img.style.height = "100%";
        img.style.objectFit = "contain";

        var m0 = noteDialog.querySelector(".tqModal");
        if (m0){ m0.style.width = ""; m0.style.height = ""; }
        return;
      }

      var modal = noteDialog.querySelector(".tqModal");
      var bar   = noteDialog.querySelector(".tqBar");
      var wrap  = noteDialog.querySelector(".noteFrameWrap");
      if (!modal || !bar || !wrap) return;

      // Hard caps (match existing desktop intent).
      var maxW = Math.min(1200, Math.floor(window.innerWidth  * 0.92));
      var maxH = Math.floor(window.innerHeight * 0.92);

      // Measure "chrome" once, then snap the modal to the largest size
      // that fits while preserving the image aspect ratio and keeping caption visible.
      var csModal = window.getComputedStyle(modal);
      var csBar   = window.getComputedStyle(bar);
      var csWrap  = window.getComputedStyle(wrap);

      function px(v){ return Math.max(0, parseFloat(v || "0") || 0); }

      var padX = px(csModal.paddingLeft) + px(csModal.paddingRight);
      var padY = px(csModal.paddingTop) + px(csModal.paddingBottom);
      var borderModalX = px(csModal.borderLeftWidth) + px(csModal.borderRightWidth);
      var borderModalY = px(csModal.borderTopWidth) + px(csModal.borderBottomWidth);

      var barH = bar.getBoundingClientRect().height;
      var barMarginB = px(csBar.marginBottom);

      var wrapBorderX = px(csWrap.borderLeftWidth) + px(csWrap.borderRightWidth);
      var wrapBorderY = px(csWrap.borderTopWidth) + px(csWrap.borderBottomWidth);

      // Caption lives inside wrap (grid row 2). Reserve its current height + a small buffer.
      var capH = 0;
      if (noteCaption && !noteCaption.hidden){
        capH = noteCaption.getBoundingClientRect().height;
        capH += 10; // breathing room for font rounding / zoom
      }

      var chromeW = padX + borderModalX + wrapBorderX;
      var chromeH = padY + borderModalY + barH + barMarginB + wrapBorderY;

      var availW = Math.max(240, maxW - chromeW);
      var availH = Math.max(240, maxH - chromeH - capH);

      var iw = img.naturalWidth;
      var ih = img.naturalHeight;

      // Snap: choose the largest modal that fits within caps, preserving the image aspect ratio.
      var scale = Math.min(1, availW / iw, availH / ih);

      var drawW = Math.max(1, Math.floor(iw * scale));
      var drawH = Math.max(1, Math.floor(ih * scale));

      var totalW = Math.min(maxW, drawW + chromeW);
      var totalH = Math.min(maxH, drawH + chromeH + capH);

      // Apply size to the inner window (overlay stays full-screen for stable centering).
      modal.style.width  = totalW + "px";
      modal.style.height = totalH + "px";

      // Let CSS grid manage image+caption; ensure the image uses the 1fr row.
      img.style.width = "100%";
      img.style.height = "100%";
      img.style.objectFit = "contain";
    }


    function slugify(s){
      return String(s || "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .slice(0, 60);
    }

    function noteKey(n, idx){
      if (n && n.id) return String(n.id).trim();
      if (n && n.file) return slugify(String(n.file));
      var base = (n && n.date ? String(n.date) : "") + "-" + (n && n.title ? String(n.title) : "");
      var s = slugify(base);
      return s || String(idx);
    }

    function noteKeyFromHash(){
      var m = String(location.hash || "").match(/^#\/notes\/([^\/?#]+)\b/);
      return m ? decodeURIComponent(m[1]) : "";
    }

    function parseISODateStrict(s){
      var str = String(s || "").trim();
      var m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return 0;
      var y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
      if (!Number.isFinite(y) || !Number.isFinite(mo) || !Number.isFinite(d)) return 0;
      if (mo < 1 || mo > 12 || d < 1 || d > 31) return 0;
      return Date.UTC(y, mo - 1, d);
    }

    function fmtNoteMeta(n){
      var parts = [];
      var type = String((n && n.type) ? n.type : "").trim();
      var date = String((n && n.date) ? n.date : "").trim();
      if (type) parts.push(type);
      if (date) parts.push(date);
      return parts.join(" / ") || "—";
    }

    function noteTypeKey(n){
      var t = String((n && n.type) ? n.type : "").trim().toLowerCase();
      if (!t) return "other";
      if (t === "footnotes") t = "footnote";
      if (t === "photos") t = "photo";
      if (t === "images") t = "image";
      if (t === "article" || t === "footnote") return "article";
      return t;
    }

    function ledClassForType(n){
      var k = noteTypeKey(n);
      if (k === "zine")  return "led-zine";
      if (k === "video") return "led-video";
      if (k === "photo") return "led-photo";
      if (k === "pdf")   return "led-pdf";
      if (k === "article") return "led-article";
      return "led-other";
    }

    function getNotesOrder(){
      var notes = Array.isArray(DATA.notes) ? DATA.notes : [];
      var ids = [];
      for (var i=0;i<notes.length;i++) ids.push(i);

      function ts(i){
        return parseISODateStrict((notes[i] || {}).date);
      }

      if (notesSortMode === "type"){
        ids.sort(function(a,b){
          var ka = noteTypeKey(notes[a] || {});
          var kb = noteTypeKey(notes[b] || {});
          if (ka < kb) return -1 * notesSortTypeDir;
          if (ka > kb) return  1 * notesSortTypeDir;

          var d = ts(b) - ts(a);
          if (d) return d;

          return a - b;
        });
        return ids;
      }

      ids.sort(function(a,b){
        var ta = ts(a), tb = ts(b);
        var newestFirst = (notesSortDateDir < 0);
        var d2 = newestFirst ? (tb - ta) : (ta - tb);
        if (d2) return d2;
        return a - b;
      });
      return ids;
    }

    var currentNoteLedClass = "led-other";

    function openNoteDialog(title, file, caption){
      if (!noteDialog) return;

      var f = String(file || "").trim();
      var lower = f.toLowerCase();

      var fUrl = f;
      try{ fUrl = new URL(f, location.href).toString(); }
      catch(_){ fUrl = encodeURI(f); }

      if (noteCaption){
        var c = String(caption || "").trim();
        noteCaption.textContent = c;
        noteCaption.hidden = !c;
      }

      if (noteTypeLed){ noteTypeLed.className = "led " + (currentNoteLedClass || "led-other"); }

      resetNoteDialogSizing();

      if (noteImg){
        noteImg.hidden = true;
        noteImg.onload = null;
        noteImg.onerror = null;
        noteImg.removeAttribute("src");
        noteImg.alt = "";
      }
      if (noteFrame){
        noteFrame.hidden = true;
        noteFrame.removeAttribute("srcdoc");
        noteFrame.src = "about:blank";
      }
      if (notePdf){
        notePdf.hidden = true;
        notePdf.removeAttribute("src");
      }
      if (notePdfMobile){
        notePdfMobile.hidden = true;
        if (notePdfMobileBtn) notePdfMobileBtn.onclick = null;
        if (notePdfMobileTitle) notePdfMobileTitle.textContent = "PDF";
      }

      if (notePop){
        notePop.hidden = !(f && f !== "about:blank");
        notePop.onclick = function(){
          if (!f || f === "about:blank") return;
          window.open(fUrl, "_blank", "noopener");
        };
      }

      var noteFrameWrap = document.querySelector('#noteDialog .noteFrameWrap');
      if (noteFrameWrap){
        noteFrameWrap.scrollTop = 0;
        noteFrameWrap.classList.remove("isVideo");
        noteFrameWrap.classList.remove("isImg");
        noteFrameWrap.classList.remove("isFill");
      }

      try{
        if (!noteDialog.open){
          if (typeof noteDialog.showModal === "function") noteDialog.showModal();
          else noteDialog.setAttribute("open","open");
        }
      }catch(_){
        noteDialog.setAttribute("open","open");
      }
      setBodyModalOpen(true);

      setNoteNavEnabled();

      var isImg = /\.(png|jpe?g|gif|webp|bmp|svg)(\?|#|$)/i.test(lower);

      if (isImg && noteImg){
        if (noteFrameWrap) noteFrameWrap.classList.add("isImg");
        noteImg.hidden = false;
        noteImg.onload = function(){
          sizeDialogToImage(noteImg);
        };
        noteImg.onerror = function(){
          if (noteImg) noteImg.hidden = true;
          if (noteFrame){
            noteFrame.hidden = false;
            noteFrame.src = fUrl || "about:blank";
          }
        };
        try{ noteImg.decoding = "async"; noteImg.fetchPriority = "high"; }catch(_){ }
        noteImg.src = fUrl;
        noteImg.alt = title || "";
        return;
      }

      if (lower.endsWith(".pdf")){
        // PDFs via iframe everywhere (more consistent than <embed>, including mobile).
        if (noteFrame){
          noteFrame.hidden = false;
          try{ noteFrame.loading = "eager"; }catch(_){}

          // reset first to avoid some browsers "sticking" the previous doc
          noteFrame.src = "about:blank";
          noteFrame.src = (fUrl ? (fUrl + "#view=FitH") : "about:blank");
        }
        return;
      }

      if (noteFrame){
        noteFrame.hidden = false;
        try{ noteFrame.loading = "eager"; }catch(_){ }
        var isVideo = /youtube-nocookie\.com\/embed\//i.test(fUrl || "");
        if (noteFrameWrap && isVideo) noteFrameWrap.classList.add("isVideo");
        noteFrame.src = fUrl || "about:blank";
      }
    }

    function closeNoteDialog(toList){
      if (!noteDialog) return;

      resetNoteDialogSizing();
      currentNoteLedClass = "led-other";
      if (noteTypeLed) noteTypeLed.className = "led led-other";

      if (notePop) notePop.hidden = true;

      if (noteCaption){
        noteCaption.textContent = "";
        noteCaption.hidden = true;
      }

      if (noteImg){
        noteImg.hidden = true;
        noteImg.onload = null;
        noteImg.onerror = null;
        noteImg.removeAttribute("src");
        noteImg.alt = "";
      }
      if (noteFrame){
        noteFrame.hidden = true;
        noteFrame.removeAttribute("srcdoc");
        noteFrame.src = "about:blank";
      }
      if (notePdf){
        notePdf.hidden = true;
        notePdf.removeAttribute("src");
      }

      if (typeof noteDialog.close === "function") noteDialog.close();
      else noteDialog.removeAttribute("open");
      setBodyModalOpen(false);

      if (toList){
        suppressHashReopen = true;
        location.hash = "#/notes";
        setTimeout(function(){ suppressHashReopen = false; }, 0);
      }
    }

    if (noteClose) noteClose.addEventListener("click", function(){ closeNoteDialog(true); });

    if (noteDialog){
      noteDialog.addEventListener("click", function(e){
        if (e.target === noteDialog) closeNoteDialog(true);
      });
    }

    window.addEventListener("keydown", function(e){
      if (!noteDialog || !noteDialog.hasAttribute("open")) return;
      if (e.altKey || e.ctrlKey || e.metaKey) return;

      if (e.key === "Escape"){ e.preventDefault(); closeNoteDialog(true); return; }
      if (e.key === "ArrowLeft"){ e.preventDefault(); gotoNoteDelta(-1); return; }
      if (e.key === "ArrowRight"){ e.preventDefault(); gotoNoteDelta(1); return; }
    });


    // Re-snap image modal on resize (desktop). Keeps vertical images fully viewable.
    window.addEventListener("resize", function(){
      if (!noteDialog || !noteDialog.hasAttribute("open")) return;
      var wrap = noteDialog.querySelector(".noteFrameWrap");
      if (!wrap || !wrap.classList.contains("isImg")) return;
      if (noteImg && !noteImg.hidden) sizeDialogToImage(noteImg);
    });
    function buildNotesKeyIndex(){
      notesKeyToIndex.clear();
      var notes = Array.isArray(DATA.notes) ? DATA.notes : [];
      for (var i=0;i<notes.length;i++){
        notesKeyToIndex.set(noteKey(notes[i] || {}, i), i);
      }
    }

    function setNoteNavEnabled(){
      var notes = Array.isArray(DATA.notes) ? DATA.notes : [];
      var ok = notes.length > 1;
      if (notePrevBtn) notePrevBtn.disabled = !ok;
      if (noteNextBtn) noteNextBtn.disabled = !ok;
    }

    function gotoNoteDelta(delta){
      if (!noteDialog || !noteDialog.hasAttribute("open")) return;

      var notes = Array.isArray(DATA.notes) ? DATA.notes : [];
      if (notes.length < 2) return;

      var key = noteKeyFromHash();
      if (!key) return;

      buildNotesKeyIndex();
      var idx = notesKeyToIndex.has(key) ? notesKeyToIndex.get(key) : -1;
      if (idx < 0) return;

      var order = getNotesOrder();
      var pos = -1;
      for (var i=0;i<order.length;i++){
        if (order[i] === idx){ pos = i; break; }
      }
      if (pos < 0) return;

      var newPos = (pos + delta + order.length) % order.length;
      var newIdx = order[newPos];
      var newKey = noteKey(notes[newIdx] || {}, newIdx);

      suppressHashReopen = true;
      location.hash = "#/notes/" + encodeURIComponent(newKey);
      setTimeout(function(){
        suppressHashReopen = false;
        refreshNotes();
      }, 0);
    }

    if (notePrevBtn) notePrevBtn.addEventListener("click", function(){ gotoNoteDelta(-1); });
    if (noteNextBtn) noteNextBtn.addEventListener("click", function(){ gotoNoteDelta( 1); });

    function renderNotesList(){
      if (!itemsNotes) return;
      buildNotesKeyIndex();
      updateNotesSortUI();

      var notes = Array.isArray(DATA.notes) ? DATA.notes : [];
      var order = getNotesOrder();

      if (!order.length){
        itemsNotes.innerHTML = row1("No notes yet.", "");
        return;
      }

      var html = [];
      for (var j=0;j<order.length;j++){
        var idx = order[j];
        var n = notes[idx] || {};
        var key = noteKey(n, idx);

        var title = esc(String(n.title || "Untitled").trim() || "Untitled");
        var meta = esc(fmtNoteMeta(n));

        var href = "#/notes/" + encodeURIComponent(key);
        var led = '<span class="led ' + esc(ledClassForType(n)) + '" aria-hidden="true"></span>';
        var titleHtml = '<a href="' + esc(href) + '">' + title + "</a>";

        html.push(row1(titleHtml, meta, led));
      }
      itemsNotes.innerHTML = html.join("");
    }

    function refreshNotes(){
      renderNotesList();
      if (suppressHashReopen) return;

      var key = noteKeyFromHash();
      if (!key){
        closeNoteDialog(false);
        return;
      }

      buildNotesKeyIndex();
      var idx = notesKeyToIndex.has(key) ? notesKeyToIndex.get(key) : -1;

      if (idx >= 0){
        var notes = Array.isArray(DATA.notes) ? DATA.notes : [];
        var n = notes[idx] || {};
        currentNoteLedClass = ledClassForType(n);

        var title = String(n.title || "Untitled").trim() || "Untitled";

        var yt = String(n.youtube || "").trim();
        var file = "";
        if (yt){
          yt = yt.replace(/[^a-zA-Z0-9_-]/g, "");
          file = "https://www.youtube-nocookie.com/embed/" + yt + "?rel=0";
        } else {
          file = String(n.file || "").trim();
        }

        if (!file){
          openNoteDialog(title, "about:blank", n.caption);
          try{
            noteFrame.src = "about:blank";
            noteFrame.srcdoc =
              "<!doctype html><meta charset=utf-8><title>Missing file</title>" +
              "<style>body{font-family:ui-monospace,Menlo,Monaco,Consolas,monospace;padding:18px}code{background:#eee;padding:2px 4px}</style>" +
              "<h3>Missing note file</h3><p>This note has no <code>file</code> property.</p>";
          }catch(_){}
          return;
        }

        openNoteDialog(title, file, n.caption);
        return;
      }

      closeNoteDialog(false);
    }

    // -------------------------------------------------------
    // JS: TIMEQUOTES
    // -------------------------------------------------------
    var timeDialog = $("timeDialog");
    var timePrev = $("timePrev");
    var timeNext = $("timeNext");
    var timeClose = $("timeClose");
    var timeQuoteText = $("timeQuoteText");
    var timeQuoteMeta = $("timeQuoteMeta");
    var timeIdx = $("timeIdx");
    var clockBtn = $("clockBtn");

    var qi = Number(localStorage.getItem("timeQuoteIndex") || 0) || 0;

    function pad2(n){ return (n < 10 ? ("0" + n) : String(n)); }

    function renderTimeQuote(){
      var quotes = Array.isArray(DATA.timeQuotes) ? DATA.timeQuotes : [];
      var total = quotes.length;

      if (!total){
        if (timeQuoteText) timeQuoteText.textContent = "> (add quote here)";
        if (timeQuoteMeta) timeQuoteMeta.textContent  = ">> (work / author)";
        if (timeIdx) timeIdx.textContent = "00/00";
        return;
      }

      qi = ((qi % total) + total) % total;
      var q = quotes[qi] || {};
      var text = String(q.quote || "").trim();
      var work = String(q.work || "").trim();
      var author = String(q.author || "").trim();

      if (timeQuoteText) timeQuoteText.textContent = "> " + (text || "(add quote here)");

      var metaParts = [];
      if (work) metaParts.push(work);
      if (author) metaParts.push(author);
      if (timeQuoteMeta) timeQuoteMeta.textContent = ">> " + (metaParts.join(" / ") || "(work / author)");

      if (timeIdx) timeIdx.textContent = pad2(qi + 1) + "/" + pad2(total);

      localStorage.setItem("timeQuoteIndex", String(qi));
    }

    function openTimeDialog(){
      if (!timeDialog) return;
      renderTimeQuote();
      if (typeof timeDialog.showModal === "function") timeDialog.showModal();
      else timeDialog.setAttribute("open", "open");
      setBodyModalOpen(true);
    }

    function closeTimeDialog(){
      if (!timeDialog) return;
      if (typeof timeDialog.close === "function") timeDialog.close();
      else timeDialog.removeAttribute("open");
      setBodyModalOpen(false);
    }

    if (timePrev){ timePrev.addEventListener("click", function(){ qi -= 1; renderTimeQuote(); }); }
    if (timeNext){ timeNext.addEventListener("click", function(){ qi += 1; renderTimeQuote(); }); }
    if (timeClose){ timeClose.addEventListener("click", closeTimeDialog); }

    if (timeDialog){
      timeDialog.addEventListener("click", function(e){
        if (e.target === timeDialog) closeTimeDialog();
      });
    }

    window.addEventListener("keydown", function(e){
      if (!timeDialog || !timeDialog.hasAttribute("open")) return;
      if (e.key === "Escape") closeTimeDialog();
      if (e.key === "ArrowLeft"){ qi -= 1; renderTimeQuote(); }
      if (e.key === "ArrowRight"){ qi += 1; renderTimeQuote(); }
    });

    if (clockBtn){
      clockBtn.addEventListener(isCoarsePointer() ? "click" : "dblclick", function(e){
        e.preventDefault();
        openTimeDialog();
      });
    }

    // -------------------------------------------------------
    // JS: ABOUT (nameplate modal)
    // -------------------------------------------------------
    var aboutDialog = $("aboutDialog");
    var aboutPrev = $("aboutPrev");
    var aboutNext = $("aboutNext");
    var aboutClose = $("aboutClose");
    var aboutText = $("aboutText");
    var aboutTitle = $("aboutTitle");

    var aboutSlides = Array.isArray(DATA.aboutSlides) ? DATA.aboutSlides : [];
    var ai = Number(localStorage.getItem("aboutSlideIndex") || 0) || 0;

    function fitAboutAscii(){
      if (!aboutText) return;

      var pre = aboutText.querySelector("pre.ascii");
      if (!pre) return;

      if (!pre.dataset.baseFont){
        var base = parseFloat(getComputedStyle(pre).fontSize) || 8;
        pre.dataset.baseFont = String(base);
      }

      var baseFont = parseFloat(pre.dataset.baseFont) || 8;
      pre.style.fontSize = baseFont + "px";

      var boxW = aboutText.clientWidth || 0;
      var contentW = pre.scrollWidth || 0;
      if (!boxW || !contentW) return;

      var scale = Math.min(1, (boxW - 2) / contentW);
      var newFont = Math.max(3.5, baseFont * scale);

      var boxH = aboutText.clientHeight || 0;
      var contentH = pre.scrollHeight || 0;
      if (boxH && contentH){
        var scaleH = Math.min(1, (boxH - 2) / contentH);
        newFont = Math.max(3.5, Math.min(newFont, baseFont * scaleH));
      }

      pre.style.fontSize = newFont.toFixed(2) + "px";
      pre.style.lineHeight = "1.0";
    }

    function renderAboutSlide(){
      var total = aboutSlides.length;

      if (!total){
        if (aboutTitle) aboutTitle.textContent = "About";
        if (aboutText) aboutText.textContent = "> (add DATA_REMOTE.aboutSlides in data.js)";
        return;
      }

      ai = ((ai % total) + total) % total;
      var s = aboutSlides[ai] || {};

      var title = String(s.title || "").trim();

      var hasHTML = (s.html != null && String(s.html).trim() !== "");
      var rawText = String(s.text || s.body || "").trim();
      var rawHTML = hasHTML ? String(s.html).trim() : "";

      if (aboutTitle) aboutTitle.textContent = title || "About";

      if (aboutText){
        if (hasHTML){
          aboutText.innerHTML = rawHTML;
        } else {
          aboutText.textContent = "> " + (rawText || "(empty)");
        }
      }

      localStorage.setItem("aboutSlideIndex", String(ai));
      setTimeout(fitAboutAscii, 0);
    }

    function openAboutDialog(){
      if (!aboutDialog) return;
      aboutSlides = Array.isArray(DATA.aboutSlides) ? DATA.aboutSlides : [];
      renderAboutSlide();
      try{
        if (!aboutDialog.open){
          if (typeof aboutDialog.showModal === "function") aboutDialog.showModal();
          else aboutDialog.setAttribute("open","open");
        }
      }catch(_){
        aboutDialog.setAttribute("open","open");
      }
      setBodyModalOpen(true);
    }

    function closeAboutDialog(){
      if (!aboutDialog) return;
      if (typeof aboutDialog.close === "function") aboutDialog.close();
      else aboutDialog.removeAttribute("open");
      setBodyModalOpen(false);
    }

    if (aboutPrev) aboutPrev.addEventListener("click", function(){ ai -= 1; renderAboutSlide(); });
    if (aboutNext) aboutNext.addEventListener("click", function(){ ai += 1; renderAboutSlide(); });
    if (aboutClose) aboutClose.addEventListener("click", closeAboutDialog);

    if (aboutDialog){
      aboutDialog.addEventListener("click", function(e){
        if (e.target === aboutDialog) closeAboutDialog();
      });
    }

    window.addEventListener("resize", function(){
      if (aboutDialog && aboutDialog.open) fitAboutAscii();
    });

    window.addEventListener("keydown", function(e){
      if (!aboutDialog || !aboutDialog.hasAttribute("open")) return;
      if (e.key === "Escape"){ e.preventDefault(); closeAboutDialog(); }
      if (e.key === "ArrowLeft"){ e.preventDefault(); ai -= 1; renderAboutSlide(); }
      if (e.key === "ArrowRight"){ e.preventDefault(); ai += 1; renderAboutSlide(); }
    });

    // -------------------------------------------------------
    // JS: ROUTER
    // -------------------------------------------------------
    var panels = {
      home: $("p-home"),
      writing: $("p-writing"),
      research: $("p-research"),
      notes: $("p-notes"),
      contact: $("p-contact")
    };
    var links = {
      home: $("linkHomeTop"),
      writing: $("linkWriting"),
      research: $("linkResearch"),
      notes: $("linkNotes"),
      contact: $("linkContact")
    };

    function normalizeRoute(hash){
      var raw = String(hash || "");
      var m = raw.match(/^#\/(home|writing|research|notes|contact)\b/);
      return m ? m[1] : "home";
    }

    function setActive(key){
      Object.keys(panels).forEach(function(k){
        if (panels[k]) panels[k].classList.toggle("isActive", k === key);
      });
      Object.keys(links).forEach(function(k){
        if (links[k]) links[k].classList.toggle("isActive", k === key);
      });

      if (key !== "notes") closeNoteDialog(false);

      if (key === "home") requestAnimationFrame(panCenter);
      if (key === "notes") requestAnimationFrame(refreshNotes);
    }

    document.addEventListener("click", function(e){
      var a = e.target.closest("a[data-route]");
      if (!a) return;
      e.preventDefault();
      var key = a.dataset.route || "home";
      location.hash = "#/" + key;
    });

    // Home nameplate opens About modal on DOUBLE-CLICK
    var homeNameplate = $("linkHomeTop");
    if (homeNameplate){
      homeNameplate.addEventListener("dblclick", function(e){
        e.preventDefault();
        e.stopPropagation();
        location.hash = "#/home";
        setTimeout(openAboutDialog, 0);
      });

      // Mobile: single tap opens About when already on Home
      homeNameplate.addEventListener("click", function(e){
        if (!isCoarsePointer()) return;
        var r = normalizeRoute(location.hash);
        if (r !== "home") return;
        e.preventDefault();
        e.stopPropagation();
        setTimeout(openAboutDialog, 0);
      });
    }

    window.addEventListener("hashchange", function(){
      var r = normalizeRoute(location.hash);
      setActive(r);
      if (r === "notes") refreshNotes();
    });

    // -------------------------------------------------------
    // JS: INIT
    // -------------------------------------------------------
    if (!location.hash) location.hash = "#/home";
    setActive(normalizeRoute(location.hash));

    render("writing");
    render("research");
    render("factChecking");

    refreshNotes();

    showSlide(slideIndex);
    requestAnimationFrame(function(){
      setCanvasForSlide();
      panCenter();
    });
  }

  // Load data.js ONCE, then boot.
  var DATA_VERSION = ""; // set to e.g. "2026-02-23" to force-refresh data.js cache
  var src = "data.js" + (DATA_VERSION ? ("?v=" + encodeURIComponent(DATA_VERSION)) : "");

  var s = document.createElement("script");
  s.src = src;
  s.async = true;
  s.onload = function(){ boot(); };
  s.onerror = function(){
    console.warn("data.js failed to load — booting with empty DATA_REMOTE.");
    boot();
  };
  document.head.appendChild(s);
})();
</script>

</body>
</html>
